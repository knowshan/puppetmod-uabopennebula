<%= "#!/bin/bash" %>

<%# Create build command %>
<% case one_db_backend
when "sqlite"
  build_command = 'scons' %>
<% when 'mysql'
  build_command = 'scons mysql=yes' %>
<% else
  build_command = 'echo' %>
<% end %>
<%# Create install command %>
<% install_command =  "./install.sh -u #{one_user} -g #{one_group} -d #{one_location}" %>
<% cleanup_command = "rm -rf $ONETEMP" %>
ONETEMP=$( mktemp -d )
<%= "/usr/bin/wget --no-check-certificate -O $ONETEMP/opennebula-#{one_version}.tar.gz https://github.com/OpenNebula/one/tarball/release-#{one_version}" %>
pushd $ONETEMP
<%= "mkdir opennebula-#{one_version}" %>
<%= "tar xzf opennebula-#{one_version}.tar.gz -C opennebula-#{one_version} --strip-component 1" %>
<%= "pushd opennebula-#{one_version}" %>
# Create install location dir and set permissions
<%= "mkdir -p #{one_location}" %>
<%= "rm -rf #{one_location}/*" %>
<%= "chown #{one_user}:#{one_group} #{one_location}" %>
<%= "# Build/Compile using scons" %>
<%= "#{build_command}" %>
<%= "# Run install script" %>
<%= "#{install_command}" %>
popd
<%= "#{cleanup_command}" %>
popd
